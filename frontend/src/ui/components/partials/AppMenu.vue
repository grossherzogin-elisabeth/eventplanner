<template>
    <div v-if="signedInUser.key" class="menu flex-1 overflow-y-auto">
        <h1 class="mb-8 mt-8 px-8 text-2xl font-thin xl:pl-14">{{ config.menuTitle }}</h1>

        <div v-if="signedInUser.impersonated" class="mx-4 rounded-2xl bg-error-container pl-4 text-onerror-container xl:mx-8 xl:pl-6">
            <div class="flex items-center">
                <i18n-t tag="p" keypath="navigation.impersonate" class="mr-2 w-0 flex-grow py-4 text-sm font-bold">
                    <span class="italic">{{ signedInUser.firstName }} {{ signedInUser.lastName }}</span>
                </i18n-t>
                <button class="icon-button mr-2" title="Impersonate Modus beenden" @click="authUseCase.impersonateUser(null)">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                </button>
            </div>
        </div>

        <ul class="menu-list my-4">
            <li v-if="signedInUser.permissions.includes(Permission.READ_EVENTS)" class="menu-item">
                <RouterLink :to="{ name: Routes.Home }">
                    <i class="fa-solid fa-home"></i>
                    <span>{{ $t('navigation.myNextEvents') }}</span>
                </RouterLink>
            </li>
            <li v-else class="menu-item">
                <RouterLink :to="{ name: Routes.Onboarding }">
                    <i class="fa-solid fa-home"></i>
                    <span>{{ $t('navigation.start') }}</span>
                </RouterLink>
            </li>
            <li :class="{ expanded: eventsExpanded }" class="permission-read-events menu-item">
                <button @click="eventsExpanded = !eventsExpanded">
                    <i class="fa-solid fa-calendar-days"></i>
                    <span>{{ $t('navigation.calendar') }}</span>
                    <i class="menu-chevron fa-solid fa-chevron-right"></i>
                </button>
                <ul v-if="eventsExpanded" class="space-y-1 pb-4">
                    <li
                        v-for="y in years"
                        :key="y"
                        class="menu-item level-2"
                        :class="{ active: eventRouteActive && eventRoute === `${Routes.EventsCalendar}:${y}` }"
                    >
                        <RouterLink :to="{ name: Routes.EventsCalendar, params: { year: y } }">
                            <span>{{ y }}</span>
                        </RouterLink>
                    </li>
                </ul>
            </li>
            <li class="permission-read-events menu-item" :class="{ active: eventRouteActive && eventRoute === Routes.EventsList }">
                <RouterLink :to="{ name: Routes.EventsList }">
                    <i class="fa-solid fa-compass"></i>
                    <span>{{ $t('navigation.allEvents') }}</span>
                </RouterLink>
            </li>
            <li class="permission-write-events menu-item" :class="{ active: eventRouteActive && eventRoute === Routes.EventsListAdmin }">
                <RouterLink :to="{ name: Routes.EventsListAdmin }">
                    <i class="fa-solid fa-compass-drafting"></i>
                    <span>{{ $t('navigation.manageEvents') }}</span>
                </RouterLink>
            </li>
            <li class="permission-read-user-details menu-item">
                <RouterLink :to="{ name: Routes.UsersList }">
                    <i class="fa-solid fa-users"></i>
                    <span>{{ $t('navigation.manageUsers') }}</span>
                </RouterLink>
            </li>
            <li
                v-if="
                    signedInUser.permissions.includes(Permission.WRITE_QUALIFICATIONS) ||
                    signedInUser.permissions.includes(Permission.WRITE_POSITIONS)
                "
                class="menu-item"
            >
                <RouterLink :to="{ name: Routes.Basedata }">
                    <i class="fa-solid fa-database"></i>
                    <span>{{ $t('navigation.manageBaseData') }}</span>
                </RouterLink>
            </li>
            <li class="permission-write-application-settings menu-item">
                <RouterLink :to="{ name: Routes.AppSettings }">
                    <i class="fa-solid fa-gear"></i>
                    <span>{{ $t('navigation.manageSettings') }}</span>
                </RouterLink>
            </li>
            <li class="menu-item">
                <RouterLink :to="{ name: Routes.SystemInfo }">
                    <i class="fa-solid fa-comment"></i>
                    <span>{{ $t('navigation.feedback') }}</span>
                </RouterLink>
            </li>
            <li class="menu-item">
                <RouterLink :to="{ name: Routes.Account }">
                    <i class="fa-solid fa-user-circle"></i>
                    <span>{{ $t('navigation.account') }}</span>
                </RouterLink>
            </li>
            <li class="menu-item">
                <a type="button" @click="authUseCase.logout()">
                    <i class="fa-solid fa-sign-out"></i>
                    <span>{{ $t('navigation.signOut') }}</span>
                </a>
            </li>
        </ul>
        <!-- TODO do we need this? -->
        <h2 class="menu-subheading hidden">{{ $t('navigation.legal') }}</h2>
        <ul class="menu-list my-4 hidden">
            <li class="menu-item">
                <RouterLink :to="{ name: Routes.Privacy }">
                    <i class="fa-solid fa-user-shield"></i>
                    <span>{{ $t('navigation.dataPrivacy') }}</span>
                </RouterLink>
            </li>
            <li class="menu-item">
                <RouterLink :to="{ name: Routes.Imprint }">
                    <i class="fa-solid fa-section"></i>
                    <span>{{ $t('navigation.imprint') }}</span>
                </RouterLink>
            </li>
        </ul>
    </div>
    <div v-else-if="loading || route.name === Routes.Login" class="menu animate-pulse">
        <div class="mx-12 my-4 h-6 rounded-full bg-current opacity-10"></div>
        <div class="mx-12 mb-12 h-6 w-1/2 rounded-full bg-current opacity-10"></div>

        <div class="mx-12 mb-6 h-6 rounded-full bg-current opacity-10"></div>
        <div class="mx-12 mb-6 h-6 rounded-full bg-current opacity-10"></div>
        <div class="mx-12 mb-6 h-6 rounded-full bg-current opacity-10"></div>
        <div class="mx-12 mb-6 h-6 rounded-full bg-current opacity-10"></div>
        <div class="mx-12 mb-6 h-6 rounded-full bg-current opacity-10"></div>
        <div class="mx-12 mb-6 h-6 rounded-full bg-current opacity-10"></div>
    </div>
    <div v-else>
        <h1 class="mb-8 mt-4 px-8 text-2xl font-thin xl:pl-14">{{ config.menuTitle }}</h1>
        <VInfo class="mx-8">
            <h2 class="mb-2">Noch kein Account?</h2>
            <p class="mb-2">
                Mit einem Lissi Account kannst du jederzeit den Status deiner n√§chsten Reisen einsehen und dich zu Reisen an und abmelden.
            </p>
        </VInfo>
        <ul class="menu-list my-4">
            <li class="menu-item">
                <RouterLink :to="{ name: Routes.Login }">
                    <i class="fa-solid fa-sign-in-alt"></i>
                    <span>Zum Login</span>
                </RouterLink>
            </li>
            <li class="menu-item">
                <RouterLink :to="{ name: Routes.Login }">
                    <i class="fa-solid fa-user-circle"></i>
                    <span>Jetzt registrieren</span>
                </RouterLink>
            </li>
        </ul>
    </div>
</template>
<script lang="ts" setup>
import { ref, watch } from 'vue';
import { useRoute } from 'vue-router';
import type { SignedInUser } from '@/domain';
import { Permission } from '@/domain';
import { VInfo } from '@/ui/components/common';
import { useAuthUseCase, useConfig } from '@/ui/composables/Application';
import { Routes } from '@/ui/views/Routes';

const config = useConfig();
const authUseCase = useAuthUseCase();
const route = useRoute();

const eventRoute = ref<string | undefined>(undefined);
const eventRouteActive = ref<boolean>(false);

const signedInUser = ref<SignedInUser>(authUseCase.getSignedInUser());
const loading = ref<boolean>(true);
const years: number[] = [new Date().getFullYear() - 1, new Date().getFullYear(), new Date().getFullYear() + 1];
const eventsExpanded = ref<boolean>(false);

authUseCase.onLogin().then(() => (signedInUser.value = authUseCase.getSignedInUser()));
setTimeout(() => (loading.value = false), 1000);
watch(route, () => {
    eventRouteActive.value = route.matched.find((it) => it.name === 'app_event-parent') !== undefined;
    if (route.name === Routes.EventsCalendar) {
        eventRoute.value = Routes.EventsCalendar + ':' + route.params.year;
    } else if (route.name === Routes.EventsListAdmin) {
        eventRoute.value = Routes.EventsListAdmin;
    } else if (route.name === Routes.EventsList || eventRoute.value === undefined) {
        eventRoute.value = Routes.EventsList;
    }
});
</script>

<style>
.menu-list {
    @apply space-y-1;
    @apply px-4;
    @apply xl:px-8;
}

.menu-list * {
    text-align: left;
}

.menu-list *:hover {
    text-decoration-line: none;
}

.menu-item {
    overflow: hidden;
    cursor: pointer;
    @apply rounded-2xl;
    @apply font-semibold;
    @apply md:text-lg;
}

.menu-item > a,
.menu-item > button {
    width: 100%;
    display: flex;
    align-items: center;
    @apply px-4;
    @apply py-2;
    @apply xl:px-6;
}

/* expand */
.menu-item.expanded {
    @apply bg-secondary-container/10;
}

.menu-item .menu-chevron {
    transition-property: transform;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 75ms;
}

.menu-item.expanded .menu-chevron {
    @apply rotate-90;
}

/* hover */
.menu-item:hover:not(.expanded):not(.active) > a:not(.router-link-active),
.menu-item:hover:not(.expanded):not(.active) > button:not(.router-link-active) {
    @apply bg-secondary-container/50;
}

/* active */
.menu-item > a.router-link-active,
.menu-item.active > a,
.menu-item.active > button {
    position: relative;
    @apply bg-secondary-container;
    @apply text-onsecondary-container;
    @apply font-bold;
}

.menu-item > a.router-link-active:before,
.menu-item.active > a:before {
    position: absolute;
    top: auto;
    bottom: auto;
    left: 0;
    background-color: currentColor;
    @apply h-5;
    @apply w-1;
    @apply rounded-full;
}

/* 2nd level */
.menu-item.level-2 {
    @apply mx-2;
    @apply rounded-xl;
    @apply text-base;
}

.menu-item.level-2 > a,
.menu-item.level-2 > button {
    @apply pl-8;
}

.menu-item span {
    flex-grow: 1;
    @apply ml-4;
    @apply md:ml-8;
}

.menu-item svg {
    display: inline-block;
    @apply h-4;
    @apply w-4;
}

.menu-subheading {
    @apply mt-8;
    @apply pl-8;
    @apply text-sm;
    @apply font-semibold;
    @apply opacity-50;
    @apply xl:pl-14;
}
</style>
